{% extends "base.html" %}
{% block title %}Grupos{% endblock %}

{% block content %}
<div class="container py-5">

  <!-- Flash messages -->
  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="mt-3">
        {% for msg in messages %}
          <div class="alert alert-info alert-dismissible fade show" role="alert">
            {{ msg }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="row justify-content-center">
    <div class="col-md-10">

      <div class="card shadow-lg border-0">
        <div class="card-body">

          <h3 class="mb-4 text-center">üë• Selecionar Grupos</h3>

          <!-- Busca -->
          <input type="text" id="search" class="form-control mb-3" placeholder="üîç Procurar grupo...">

          <!-- Lista de grupos -->
          <div id="group-list" class="list-group" style="max-height: 400px; overflow-y: auto;">
            <div class="text-center py-3 text-muted" id="loading-msg">
              ‚è≥ Carregando grupos, pode demorar alguns minutos...
            </div>
          </div>

          <!-- Bot√£o marcar todos -->
          <div class="mt-3 text-center">
            <button type="button" id="toggle-all" class="btn btn-outline-primary" disabled>
              ‚úÖ Marcar Todos
            </button>
          </div>

          <hr>

          <!-- Campo de mensagem -->
          <form method="POST" action="{{ url_for('enviar_grupos') }}" 
                enctype="multipart/form-data" id="send-form">
            <input type="hidden" name="grupos" id="selected-groups">
            <input type="hidden" name="enviarTodos" id="send-to-all" value="False">

            <div class="mb-3">
              <label class="form-label">Mensagem:</label>
              <textarea name="mensagem" class="form-control" rows="4" required></textarea>
            </div>

            <div class="mb-3">
              <label class="form-label">Imagem (opcional):</label>
              <input type="file" name="imagem" class="form-control" accept="image/*">
            </div>

            <div class="text-center">
              <button type="submit" class="btn btn-success btn-lg">üì§ Enviar</button>
            </div>
          </form>

        </div>
      </div>

    </div>
  </div>
</div>

<script nonce="{{ g.csp_nonce }}">
  const search = document.getElementById("search");
  const toggleAllBtn = document.getElementById("toggle-all");
  const selectedGroupsInput = document.getElementById("selected-groups");
  const sendToAllInput = document.getElementById("send-to-all");
  const groupList = document.getElementById("group-list");
  const loadingMsg = document.getElementById("loading-msg");

  // üîÑ Fun√ß√£o para carregar grupos via API
  async function carregarGrupos() {
    try {
      const resp = await fetch("{{ url_for('api_grupos') }}");
      const data = await resp.json();

      if (!resp.ok) throw new Error(data.error || "Erro ao carregar grupos");

      groupList.innerHTML = ""; // limpa o "carregando"
      data.grupos.forEach(g => {
        const item = document.createElement("label");
        item.className = "list-group-item d-flex align-items-center";

        item.innerHTML = `
          <input type="checkbox" class="form-check-input me-2 group-check" value="${g.id}">
          <img src="${g.pictureUrl || '/static/no-group.png'}" alt="Foto" 
               class="rounded me-2" style="width:40px;height:40px;object-fit:cover;">
          <div>
            <strong class="group-name">${g.subject || "Sem nome"}</strong><br>
            <small class="group-size">${g.size || 0} membros</small>
          </div>
        `;
        groupList.appendChild(item);
      });

      // Reaplica listeners
      document.querySelectorAll(".group-check").forEach(chk => {
        chk.addEventListener("change", checkSelection);
      });

    } catch (err) {
      groupList.innerHTML = `<div class="alert alert-danger text-center">‚ùå ${err.message}</div>`;
    }
  }

  // üîç Filtro de grupos (nome)
  search.addEventListener("input", () => {
    const term = search.value.toLowerCase().trim();
    document.querySelectorAll("#group-list .list-group-item").forEach(item => {
      const name = (item.querySelector(".group-name")?.textContent || "").toLowerCase().trim();
      item.classList.toggle("d-none", !name.includes(term));
    });
  });

  // Habilitar bot√£o "Marcar Todos" apenas quando 1 grupo selecionado
  function checkSelection() {
    const selected = document.querySelectorAll(".group-check:checked");
    toggleAllBtn.disabled = (selected.length !== 1);
  }

  // Toggle marcar todos
  toggleAllBtn.addEventListener("click", () => {
    const val = sendToAllInput.value === "True" ? "False" : "True";
    sendToAllInput.value = val;
    toggleAllBtn.innerText = val === "True" ? "üö´ Desmarcar Todos" : "‚úÖ Marcar Todos";
  });

  // Antes de enviar form ‚Üí salvar grupos selecionados e travar bot√£o
  document.getElementById("send-form").addEventListener("submit", (e) => {
    const selected = Array.from(document.querySelectorAll(".group-check:checked")).map(chk => chk.value);
    selectedGroupsInput.value = JSON.stringify(selected);

    if (selected.length === 0) {
      e.preventDefault();
      alert("Selecione pelo menos 1 grupo!");
      return;
    }

    const submitBtn = e.target.querySelector("button[type='submit']");
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.innerText = "‚è≥ Enviando...";
    }
  });

  // üöÄ Carregar grupos ao abrir p√°gina
  carregarGrupos();
</script>
{% endblock %}
