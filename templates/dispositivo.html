{% extends "base.html" %}
{% block title %}Dispositivo{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row justify-content-center g-4">
    
    <!-- Coluna esquerda: Gerenciador -->
    <div class="col-lg-6">
      <div class="card p-4 h-100">
        <h4 class="mb-3 d-flex align-items-center">
          <i class="bi bi-phone me-2 text-primary"></i> 
          Gerenciador de Dispositivos
        </h4>
        <p class="text-muted">Conecte e gerencie suas instâncias WhatsApp</p>

        <!-- Status -->
        {% if status %}
        <div id="status-box"
             class="alert {% if conectado %}alert-success{% elif expirado %}alert-warning{% else %}alert-info{% endif %}">
          {{ status }}
        </div>
        {% endif %}

        <!-- Instância conectada -->
        {% if conectado and dispositivo_nome %}
          <h5 class="mb-3">🔗 Instância ativa: <b>{{ dispositivo_nome }}</b></h5>
          <form method="POST">
            <input type="hidden" name="acao" value="deletar">
            <button type="submit" class="btn btn-danger w-100">
              <i class="bi bi-trash me-2"></i> Deletar Instância
            </button>
          </form>

        <!-- Criar nova instância -->
        {% elif not dispositivo_nome %}
          <form method="POST" class="mt-3">
            <div class="mb-3">
              <label for="nomeInstancia" class="form-label">Nome da Instância</label>
              <input type="text" class="form-control" id="nomeInstancia" name="nome" placeholder="Digite um nome único" required>
              <input type="hidden" name="acao" value="criar">
            </div>
            <button type="submit" class="btn btn-primary w-100">
              <i class="bi bi-plus-circle me-2"></i> Criar Dispositivo
            </button>
          </form>
        {% endif %}

        <!-- QR Code -->
        {% if qrcode_b64 %}
          <div class="mt-4 text-center" id="qrcode-box">
            <h5><i class="bi bi-qr-code me-2"></i> Escaneie o QR Code abaixo no WhatsApp:</h5>
            <img src="{{ qrcode_b64 }}" alt="QR Code" class="img-fluid mt-3 shadow" style="max-width: 280px;">
          </div>
        {% endif %}

        <!-- Pairing code -->
        {% if pairing_code %}
          <div class="mt-4 text-center">
            <h5><i class="bi bi-key me-2"></i> Código de Pareamento:</h5>
            <p class="fw-bold fs-4">{{ pairing_code }}</p>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Coluna direita: blocos empilhados -->
    <div class="col-lg-6 d-flex flex-column gap-4">
      <div class="card p-4">
        <h5 class="d-flex align-items-center mb-3">
          <i class="bi bi-link-45deg me-2 text-primary"></i> Como Conectar
        </h5>
        <ol class="ps-3 mb-0">
          <li>Crie um dispositivo</li>
          <li>Escaneie o QR Code</li>
          <li>Aguarde a conexão</li>
          <li>Pronto!</li>
        </ol>
      </div>

      <div class="card p-4">
        <h5 class="d-flex align-items-center mb-3">
          <i class="bi bi-exclamation-triangle me-2 text-warning"></i> Informações Importantes
        </h5>
        <ul class="mb-0 ps-3">
          <li>Cada dispositivo precisa de um nome único</li>
          <li>O QR Code expira após alguns minutos</li>
          <li>Você pode deletar e recriar dispositivos a qualquer momento</li>
          <li>Mantenha apenas um dispositivo ativo por vez</li>
        </ul>
      </div>
    </div>
  </div>
</div>

{% if qrcode_b64 and dispositivo_nome %}
<script nonce="{{ g.csp_nonce }}">
  // Polling para verificar status da instância
  let tentativas = 0;
  const maxTentativas = 12; // ~1 minuto
  const nomeInstancia = "{{ dispositivo_nome }}";

  function checarStatus() {
    fetch(`/dispositivo/status/${nomeInstancia}`)
      .then(res => res.json())
      .then(data => {
        const statusBox = document.getElementById("status-box");
        const cardBody = document.querySelector(".card.p-4");

        if (data.status === "open") {
          statusBox.className = "alert alert-success";
          statusBox.innerText = `✅ Dispositivo ${nomeInstancia} conectado!`;

          cardBody.innerHTML = `
            <h4 class="mb-3 d-flex align-items-center">
              <i class="bi bi-phone me-2 text-primary"></i> Gerenciador de Dispositivos
            </h4>
            <div class="alert alert-success">✅ Dispositivo ${nomeInstancia} conectado!</div>
            <h5 class="mb-3">🔗 Instância ativa: <b>${nomeInstancia}</b></h5>
            <form method="POST">
              <input type="hidden" name="acao" value="deletar">
              <button type="submit" class="btn btn-danger w-100">
                <i class="bi bi-trash me-2"></i> Deletar Instância
              </button>
            </form>
          `;
          return;
        }

        tentativas++;
        if (tentativas < maxTentativas) {
          setTimeout(checarStatus, 5000);
        } else {
          statusBox.className = "alert alert-warning";
          statusBox.innerText = "⏱️ QR Code expirado. Gere novamente.";
        }
      })
      .catch(err => console.error("Erro ao checar status:", err));
  }

  setTimeout(checarStatus, 5000);
</script>
{% endif %}
{% endblock %}
